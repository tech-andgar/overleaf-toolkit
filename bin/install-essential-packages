#!/usr/bin/env bash

set -euo pipefail

ESSENTIAL_PACKAGES=(
    "titlesec"
    "enumitem"
    "fontawesome5"
)

PACKAGES_INSTALLED=false # Flag to track if any package was installed

echo "Updating tlmgr..."
docker exec sharelatex tlmgr update --self

echo "Waiting for sharelatex container to be ready..."
while ! docker exec sharelatex /bin/true > /dev/null 2>&1; do
    echo "Sharelatex container not ready yet, waiting..."
    sleep 5
done
echo "Sharelatex container is ready."

echo "Installing essential packages..."
for package in "${ESSENTIAL_PACKAGES[@]}"; do
    echo "Checking if ${package} is installed and accessible to LaTeX..."
    if docker exec sharelatex kpsewhich "${package}.sty" > /dev/null 2>&1; then
        echo "${package} is already installed and accessible. Skipping."
    else
        echo "${package} is not installed or not accessible. Installing..."
        docker exec sharelatex tlmgr install "${package}" || true
        PACKAGES_INSTALLED=true # Set flag to true if a package is installed
    fi
done

if [ "$PACKAGES_INSTALLED" = true ]; then
    docker exec sharelatex tlmgr path add

    CURRENT_VERSION=$(cat config/version)
    NEW_VERSION="${CURRENT_VERSION}-with-essential-packages"

    echo "Committing changes to new image with tag '${NEW_VERSION}'..."
    docker commit sharelatex "sharelatex/sharelatex:${NEW_VERSION}"

    echo "Updating config/version to '${NEW_VERSION}'..."
    echo "${NEW_VERSION}" > config/version

    echo "Restarting Overleaf..."
    ./bin/up -d
else
    echo "No new packages were installed. Skipping image commit and Overleaf restart."
fi

echo "Done!"